@{
    ViewData["Title"] = "用户管理";
}

<h1>用户管理</h1>

<table class="table table-striped">
    <thead>
        <tr>
            <th>用户名</th>
            <th>邮箱</th>
            <th>角色</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody id="userTableBody">
        <!-- 用户数据将通过 JavaScript 动态加载 -->
    </tbody>
</table>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除用户 <strong id="modalUsername"></strong> 吗？</p>
                <div class="mb-3">
                    <label for="adminPassword" class="form-label">请输入管理员密码确认：</label>
                    <input type="password" class="form-control" id="adminPassword" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">确认删除</button>
            </div>
        </div>
    </div>
</div>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        let userIdToDelete = null;

const token = localStorage.getItem("token");
        // 获取用户数据并渲染表格
        function loadUsers() {
            $.ajax({
                url: '/api/v1/backstageapi/users',
                type: 'GET',
headers: token ? { "Authorization": `Bearer ${token}` } : {},
                success: function (data) {
                    const userTableBody = $('#userTableBody');
                    userTableBody.empty(); // 清空表格内容

                    data.forEach(user => {
                        const row = `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>${user.role}</td>
                                <td>
                                    <a class="btn btn-primary btn-sm" href="/Backstage/Edit/${user.id}">编辑</a>
                                    <button class="btn btn-danger btn-sm delete-user-btn" data-user-id="${user.id}" data-username="${user.username}">删除</button>
                                </td>
                            </tr>
                        `;
                        userTableBody.append(row);
                    });

                    // 绑定删除按钮事件
                    $('.delete-user-btn').on('click', function () {
                        userIdToDelete = $(this).data('user-id');
                        const username = $(this).data('username');
                        $('#modalUsername').text(username);
                        $('#deleteModal').modal('show');
                    });
                },
                error: function () {
                    alert('无法加载用户数据，请稍后重试！');
                }
            });
        }

        // 加载用户数据
        loadUsers();

        // 确认删除按钮点击事件
        $('#confirmDeleteButton').on('click', function () {
            const adminPassword = $('#adminPassword').val();

            if (!adminPassword) {
                alert('请输入管理员密码！');
                return;
            }

            // 发起删除请求
            $.ajax({
                url: `/api/v1/backstage/users/${userIdToDelete}`,
                type: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ password: adminPassword }),
                success: function () {
                    alert('用户删除成功！');
                    $('#deleteModal').modal('hide');
                    loadUsers(); // 重新加载用户数据
                },
                error: function () {
                    alert('删除失败，请检查密码是否正确！');
                }
            });
        });
    });
</script>